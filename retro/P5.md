# Phase 5 Retrospective: User Story 4 - Isolated Execution Environment

**Feature**: 001-smile-loop
**Phase**: 5 - US4 Container Management
**Started**: 2026-02-03
**Completed**: 2026-02-03

## Objectives

- Create Container and ContainerStatus types
- Implement Docker connection and health check via bollard
- Implement container creation with volume mounts
- Implement container start/stop/remove lifecycle
- Implement container reset (stop, remove, recreate)

## Decisions Made

1. **Builder Pattern for CreateContainerOptions**: Used a builder pattern with methods like `with_mount()`, `with_env()`, `with_cmd()` for flexible container configuration. This allows adding mounts and environment variables incrementally.

2. **Test Module Attributes**: Added `#[allow(clippy::unwrap_used, clippy::expect_used, clippy::panic)]` to test modules since the project's strict clippy configuration disallows these even in tests. This follows the pattern established in smile-orchestrator/config.rs.

3. **Docker-Dependent Tests**: Tests requiring a running Docker daemon are marked with `#[ignore = "requires running Docker daemon"]`. This allows the test suite to pass in CI environments without Docker while still having integration tests available for local development.

4. **Mount Path Validation**: Implemented `validate_mount_path()` to check that host paths exist before creating containers, returning `ContainerError::InvalidMountPath` early rather than waiting for Docker API errors.

5. **Graceful Reset Handling**: The `reset_container` method handles already-stopped containers gracefully by attempting to stop but ignoring errors, then using force removal.

6. **Docker State Mapping**: Created a comprehensive mapping from Docker's `ContainerStateStatusEnum` to our `ContainerStatus` enum:
   - RUNNING/RESTARTING -> Running
   - PAUSED -> Paused
   - CREATED -> Created
   - EXITED/DEAD -> Stopped
   - REMOVING -> Removing
   - EMPTY -> Stopped (with warning)

## Learnings

1. **Clippy Test Module Restrictions**: The project's strict clippy configuration applies to test code too. `expect_used` and `panic` lints fire on test code, requiring explicit `#[allow()]` attributes on test modules.

2. **Doc Comment Backticks**: The `doc_markdown` lint requires backticks around method names and type names in documentation comments. `/// Test that start_container returns` should be `/// Test that \`start_container\` returns`.

3. **Bollard Mount Format**: Bollard uses `bollard::models::Mount` with `MountTypeEnum::BIND` for volume mounts. The `source` field is the host path (as String), `target` is the container path, and `read_only` is an Option<bool>.

4. **Container Status Inspection**: The `inspect_container` API returns deeply nested optional fields. The pattern `response.state.and_then(|s| s.status).map_or(default, |status| ...)` handles the optionality cleanly.

5. **Error 404 Detection**: Bollard returns 404 errors for operations on nonexistent containers. These need to be detected by checking the error message content since there's no typed error variant.

## Issues Encountered

1. **Pre-commit Hook Formatting**: rustfmt has specific opinions about method chaining and line breaks that sometimes differ from how code is written. Running `cargo fmt` before committing resolves this.

2. **Test Code Clippy Lints**: Initial test implementations used `expect()` and `panic!()` which are forbidden by clippy. Required adding allow attributes to test modules.

3. **Cargo.lock Update**: A previous phase added the regex dependency but didn't commit the Cargo.lock change, creating a dirty working tree at phase start.

## Improvements

1. Consider adding a `wait_for_container` method that blocks until a container reaches a specific state.

2. Consider adding exec functionality for running commands inside containers.

3. The `SMILE_ITERATION` environment variable added by `reset_container_for_iteration` could be useful for debugging and logging inside the container.
