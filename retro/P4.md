# Phase 4 Retrospective: User Story 3 - Load Tutorial Content

**Feature**: 001-smile-loop
**Phase**: 4 - US3 Tutorial Loading
**Started**: 2026-02-03
**Completed**: 2026-02-03

## Objectives

- Create Tutorial struct for representing loaded tutorials
- Implement tutorial loading with size validation (100KB limit)
- Implement image reference extraction and resolution
- Integrate tutorial loading into CLI flow

## Decisions Made

1. **Separate Loading and Image Extraction**: Tutorial::load() handles file loading and validation, while extract_images() is a separate method. This allows flexibility for cases where images aren't needed. Also provided Tutorial::load_with_images() as a convenience method.

2. **Graceful Image Handling**: Missing images and unsupported formats are silently skipped rather than erroring. This matches the spec's E07 guidance that missing images are handled with "Student judgment (warn or report blocker)". The orchestrator can later decide how to handle these.

3. **URL Filtering**: Image references starting with http://, https://, or data: are skipped during extraction. These are external resources that the container will handle differently.

4. **Path Canonicalization**: Tutorial paths are canonicalized when loaded for consistent representation across the system. Falls back to the original path if canonicalization fails.

5. **Regex Without LazyLock**: Used simple Regex::new() each time instead of LazyLock since it requires Rust 1.80 but MSRV is 1.75. The image extraction is not on a hot path so performance is acceptable.

## Learnings

1. **MSRV Constraints**: LazyLock (for static regex) requires Rust 1.80, but the project MSRV is 1.75. Clippy's `incompatible_msrv` lint catches this. For MSRV-compliant lazy initialization, use once_cell crate or create resources each time.

2. **Clippy Strictness**: The project has very strict clippy lints:
   - `needless_raw_string_hashes`: r#"..."# should be r"..." when no hashes are needed
   - `needless_borrows_for_generic_args`: Don't borrow arrays when passed to functions that accept AsRef
   - `manual_let_else`: Use `let Some(x) = ... else { continue };` instead of match
   - `unnecessary_lazy_evaluations`: Use unwrap_or() instead of unwrap_or_else() for simple values

3. **Test File Isolation**: Tests create temp files with unique names to avoid conflicts when running in parallel. Always cleanup temp files even if tests pass.

## Issues Encountered

1. **Cast Truncation Warning**: `file_size as usize` triggers clippy's cast_possible_truncation. Fixed by adding explicit allow comment with justification that file_size is validated to be <= 100KB, which fits in usize on all platforms.

2. **Format Differences**: Raw string literals without hashes (r"...") are preferred over r#"..."# when the content doesn't contain double quotes.

## Improvements

1. Consider adding progress logging for large images or many images being loaded.

2. Future: Support for additional image formats (WebP) could be added to ImageFormat enum.

3. Consider caching the compiled regex if image extraction becomes a performance bottleneck.
