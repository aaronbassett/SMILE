#!/usr/bin/env python3
"""Mock LLM CLI for integration testing.

This script simulates an LLM CLI (claude, codex, gemini) by returning
predefined responses based on a scenario file. The responses are read
from MOCK_SCENARIO_FILE environment variable.

Environment Variables:
    MOCK_SCENARIO_FILE: Path to JSON file with scenario responses
    MOCK_SCENARIO_INDEX: Current response index (auto-incremented)

Scenario File Format:
{
  "responses": [
    {
      "status": "ask_mentor",
      "currentStep": "Step 2: Initialize the Project",
      "attemptedActions": ["Run npm init -y"],
      "problem": "Command not found: npm",
      "questionForMentor": "How do I install npm?",
      "summary": "Cannot proceed without npm"
    },
    {
      "status": "completed",
      "currentStep": "Step 6: Install Globally",
      "attemptedActions": ["All steps completed"],
      "summary": "Tutorial completed successfully"
    }
  ]
}
"""

import json
import os
import sys
from pathlib import Path


def main() -> int:
    """Main entry point."""
    # Get scenario file path
    scenario_file = os.environ.get("MOCK_SCENARIO_FILE")
    if not scenario_file:
        print("Error: MOCK_SCENARIO_FILE environment variable not set", file=sys.stderr)
        return 1

    scenario_path = Path(scenario_file)
    if not scenario_path.exists():
        print(f"Error: Scenario file not found: {scenario_path}", file=sys.stderr)
        return 1

    # Load scenario
    try:
        with scenario_path.open() as f:
            scenario = json.load(f)
    except json.JSONDecodeError as e:
        print(f"Error: Invalid JSON in scenario file: {e}", file=sys.stderr)
        return 1

    responses = scenario.get("responses", [])
    if not responses:
        print("Error: No responses in scenario file", file=sys.stderr)
        return 1

    # Get current index from state file (atomic increment)
    state_file = scenario_path.with_suffix(".state")
    try:
        if state_file.exists():
            index = int(state_file.read_text().strip())
        else:
            index = 0
    except ValueError:
        index = 0

    # Get response (cycle through if index exceeds length)
    response = responses[index % len(responses)]

    # Write next index to state file
    state_file.write_text(str(index + 1))

    # Output the response as JSON
    print(json.dumps(response, indent=2))
    return 0


if __name__ == "__main__":
    sys.exit(main())
