# Implementation Plan: SMILE Loop

**Branch**: `001-smile-loop` | **Date**: 2026-02-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-smile-loop/spec.md`

## Summary

SMILE Loop validates technical tutorials by simulating a constrained learner (Student agent) that attempts to follow instructions, escalating to a Mentor agent when stuck. The orchestrator manages the loop in Docker containers, tracks state, and generates comprehensive gap reports. Built with Rust (orchestrator, CLI, containers) and Python (agent wrappers, LLM integration).

## Technical Context

**Language/Version**: Rust 1.75+ (orchestrator), Python 3.11+ (wrappers)
**Primary Dependencies**:
- Rust: tokio, axum, bollard, serde, clap, tracing
- Python: httpx, pydantic, subprocess (stdlib)
**Storage**: File-based (smile.json config, .smile/state.json state file, reports)
**Testing**: cargo test (Rust), pytest (Python)
**Target Platform**: Linux, macOS, Windows (WSL2) - local Docker execution
**Project Type**: Single CLI tool with Rust workspace + Python package
**Performance Goals**:
- Config loads in <100ms
- Tutorial loads in <500ms
- Container starts in <5s
- Container resets in <3s
- WebSocket events delivered within 100ms
**Constraints**:
- Tutorials max 100KB
- Single loop at a time (no concurrency)
- Docker required
- One of claude/codex/gemini CLI required
**Scale/Scope**: Local dev tool, single user, one tutorial at a time

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Gate | Status | Notes |
|-----------|------|--------|-------|
| I. Ship Fast | Start minimal, iterate on real pain | PASS | MVP scope: local Docker, single loop, Markdown only |
| II. KISS | Each component single purpose | PASS | Clear separation: CLI → Orchestrator → Container → Agents |
| III. Modularity | Clear interfaces, no circular deps | PASS | Rust crates isolated, Python wrappers independent, HTTP API boundary |
| IV. Test What Matters | Critical paths tested | PASS | Test strategy defined: integration tests for loop, unit tests for config/report |
| V. Fail Fast | Clear context in errors | PASS | Spec defines error severity levels, human-readable error format |
| VI. Human-Readable Errors | Actionable messages | PASS | Spec mandates "What failed: context. Try: suggestion." format |
| VII. README First | Docs before feature complete | PASS | quickstart.md created, CLAUDE.md updated |
| VIII. Frictionless Setup | One command install/run | PASS | `just setup` for dev, `cargo install smile` for users |

**Gate Evaluation**: PASS - All principles verified after Phase 1 design

## Project Structure

### Documentation (this feature)

```text
specs/001-smile-loop/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output (OpenAPI, WebSocket schemas)
│   ├── orchestrator-api.yaml
│   └── websocket-events.yaml
└── tasks.md             # Generated by /sdd:tasks command
```

### Source Code (repository root)

```text
smile/
├── Cargo.toml                    # Rust workspace root
├── Justfile                      # Task runner (build, test, run, lint, format)
├── crates/
│   ├── smile-cli/                # CLI entry point
│   │   └── src/
│   │       └── main.rs
│   ├── smile-orchestrator/       # Loop logic, HTTP API, WebSocket
│   │   └── src/
│   │       ├── lib.rs
│   │       ├── api.rs            # HTTP endpoints
│   │       ├── websocket.rs      # Real-time events
│   │       ├── loop_state.rs     # State machine
│   │       └── config.rs         # smile.json handling
│   ├── smile-container/          # Docker lifecycle
│   │   └── src/
│   │       ├── lib.rs
│   │       ├── manager.rs        # Start/stop/reset
│   │       └── volume.rs         # Mount handling
│   └── smile-report/             # Report generation
│       └── src/
│           ├── lib.rs
│           ├── markdown.rs       # smile-report.md
│           └── json.rs           # smile-report.json
├── python/
│   ├── pyproject.toml            # Python package config
│   ├── smile_wrappers/
│   │   ├── __init__.py
│   │   ├── student.py            # Student agent wrapper
│   │   ├── mentor.py             # Mentor agent wrapper
│   │   ├── prompts.py            # Prompt construction
│   │   └── output.py             # Structured output handling
│   └── tests/
│       ├── test_student.py
│       ├── test_mentor.py
│       └── test_prompts.py
├── docker/
│   ├── Dockerfile.base           # smile-base image with LLM CLIs
│   └── Dockerfile.dev            # Development image
├── tests/
│   └── integration/
│       ├── test_config.rs        # Config loading tests
│       ├── test_loop.rs          # Full loop integration tests
│       └── fixtures/
│           └── sample-tutorial/  # Test tutorial with known gaps
└── .github/
    └── workflows/
        └── ci.yml                # Build, test, lint on PR/push
```

**Structure Decision**: Rust workspace with 4 crates (cli, orchestrator, container, report) + Python package for wrappers. This keeps Rust components compile-able independently while Python handles LLM-specific logic that may need rapid iteration.

## Complexity Tracking

> No constitution violations requiring justification. Design follows KISS principles with clear single-purpose components.

---

## Phase Outputs

### Phase 0: Research (Completed)

- `research.md` - Technology decisions and patterns
- `research-artifacts/` - Detailed reference materials for bollard, LLM CLI wrappers

### Phase 1: Design (Completed)

- `data-model.md` - Entity definitions with Rust/Python code
- `contracts/orchestrator-api.yaml` - OpenAPI 3.1 specification
- `contracts/websocket-events.yaml` - WebSocket event schemas
- `quickstart.md` - Developer setup guide

### Phase 2: Dev Environment (Completed)

**Rust Tooling:**
- `Cargo.toml` - Workspace with strict clippy lints
- `rustfmt.toml` - Formatting configuration
- `clippy.toml` - Lint thresholds

**Python Tooling:**
- `python/pyproject.toml` - ruff, mypy, pytest configuration

**Git Hooks:**
- `lefthook.yml` - Pre-commit (format, lint) and pre-push (test) hooks

**Task Runner:**
- `Justfile` - Common commands: build, test, lint, fmt, run

**CI/CD:**
- `.github/workflows/ci.yml` - Rust + Python CI on push/PR

**Scaffolding:**
- Rust crates: smile-cli, smile-orchestrator, smile-container, smile-report (placeholder)
- Python package: smile_wrappers with student/mentor wrappers (placeholder)

---

## Next Steps

Run `/sdd:tasks` to generate the implementation task list from this plan.
